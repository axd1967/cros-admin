<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>js\controllers\dashboardController.js - The cros-admin API</title>
    <link rel="stylesheet" href="http://yui.yahooapis.com/3.9.1/build/cssgrids/cssgrids-min.css">
    <link rel="stylesheet" href="../assets/vendor/prettify/prettify-min.css">
    <link rel="stylesheet" href="../assets/css/main.css" id="site_styles">
    <link rel="icon" href="../assets/favicon.ico">
    <script src="http://yui.yahooapis.com/combo?3.9.1/build/yui/yui-min.js"></script>
</head>
<body class="yui3-skin-sam">

<div id="doc">
    <div id="hd" class="yui3-g header">
        <div class="yui3-u-3-4">
                <h1><img src="../assets/css/logo.png" title="The cros-admin API" width="117" height="52"></h1>
        </div>
        <div class="yui3-u-1-4 version">
            <em>API Docs for: 1.0.0</em>
        </div>
    </div>
    <div id="bd" class="yui3-g">

        <div class="yui3-u-1-4">
            <div id="docs-sidebar" class="sidebar apidocs">
                <div id="api-list">
                    <h2 class="off-left">APIs</h2>
                    <div id="api-tabview" class="tabview">
                        <ul class="tabs">
                            <li><a href="#api-classes">Classes</a></li>
                            <li><a href="#api-modules">Modules</a></li>
                        </ul>
                
                        <div id="api-tabview-filter">
                            <input type="search" id="api-filter" placeholder="Type to filter APIs">
                        </div>
                
                        <div id="api-tabview-panel">
                            <ul id="api-classes" class="apis classes">
                                <li><a href="../classes/.CustomAdapter.html">.CustomAdapter</a></li>
                            </ul>
                
                            <ul id="api-modules" class="apis modules">
                            </ul>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="yui3-u-3-4">
                <div id="api-options">
                    Show:
                    <label for="api-show-inherited">
                        <input type="checkbox" id="api-show-inherited" checked>
                        Inherited
                    </label>
            
                    <label for="api-show-protected">
                        <input type="checkbox" id="api-show-protected">
                        Protected
                    </label>
            
                    <label for="api-show-private">
                        <input type="checkbox" id="api-show-private">
                        Private
                    </label>
                    <label for="api-show-deprecated">
                        <input type="checkbox" id="api-show-deprecated">
                        Deprecated
                    </label>
            
                </div>
            
            <div class="apidocs">
                <div id="docs-main">
                    <div class="content">
<h1 class="file-heading">File: js\controllers\dashboardController.js</h1>

<div class="file">
    <pre class="code prettyprint linenums">
/**
 * Created by matthias on 14/04/2015.
 */

App.DashboardController = Ember.Controller.extend({
    v : false,
	notifications: Ember.A([]),

    init : function() {
        this._super();

        this.fetchLocations();
		this.registerForEvents();
    },

    locations : undefined,

    fetchLocations : function() {
        var self = this;

        // get all drone locations
        this.adapter.find(&quot;drone&quot;, null, null).then(function(data) {
            $.each(data.resource,function(i,d) {
                var currentId = d.id;
                self.adapter.find(&quot;drone&quot;, d.id, &quot;location&quot;).then(function(data) {
                    var locs = self.get(&quot;locations&quot;) || Ember.A();
                    locs.pushObject(Ember.Object.create({
                        lat : data.location.latitude,
                        lon : data.location.longitude,
                        type : &quot;drone&quot;,
                        id : currentId
                    }));
                    self.set(&quot;locations&quot;, locs);
                });
            });
        });

        // get all basestation locations
        this.adapter.find(&quot;basestation&quot;, null, null).then(function(data) {
            $.each(data.resource,function(i,d) {
                var currentId = d.id;
                self.adapter.find(&quot;basestation&quot;, d.id, null).then(function(data) {
                    var locs = self.get(&quot;locations&quot;) || Ember.A();
                    locs.pushObject(Ember.Object.create({
                        lat : data.location.latitude,
                        lon : data.location.longitude,
                        type : &quot;basestation&quot;,
                        id : currentId
                    }));
                    self.set(&quot;locations&quot;, locs);
                });
            });
        });
    },
	
	registerForEvents: function() {
		var self = this;
		this.socketManager.register(&quot;droneAssigned&quot;, 0, &quot;dashboard&quot;, function(data, id) {
			self.adapter.find(&#x27;drone&#x27;, data.droneId).then(function(data){
				var message = data.name + &#x27; got assigned to assignment #&#x27; + id;
				var notifications = self.get(&#x27;notifications&#x27;);
				notifications.unshiftObject({ number: notifications.length, message: message, link:&#x27;assignment&#x27;, id: id, seen: false, time: self.getTime() });
			});
        });
		this.socketManager.register(&quot;assignmentStarted&quot;, 0, &quot;dashboard&quot;, function(data, id) {
			var message = &#x27;Started assignment #&#x27; + id;
			var notifications = self.get(&#x27;notifications&#x27;);
			notifications.unshiftObject({ number: notifications.length, message: message, link:&#x27;assignment&#x27;, id: id, seen: false, time: self.getTime() });
        });
		this.socketManager.register(&quot;assignmentProgressed&quot;, 0, &quot;dashboard&quot;, function(data, id) {
			self.adapter.find(&#x27;assignment&#x27;, id).then(function(assignment){
				if(assignment.assignedDrone != null) {
					var message = assignment.assignedDrone.name + &#x27; reached the next checkpoint (&#x27; + data.progress + &#x27; of &#x27; + assignment.route.length + &#x27;)&#x27;;
					var notifications = self.get(&#x27;notifications&#x27;);
					var found = false;
					for(var i = 0; i &lt; self.notifications.length; ++i) {
						var n = self.notifications[i];
						if(n.link == &#x27;drone&#x27; &amp;&amp; n.id == assignment.assignedDrone.id) {
							Ember.set(self.notifications[i], &#x27;message&#x27;, message);
							Ember.set(self.notifications[i], &#x27;seen&#x27;, false);
							Ember.set(self.notifications[i], &#x27;time&#x27;, self.getTime());
							found = true;
							break;
						}
					}
				}
				if(!found) 
					notifications.unshiftObject({ number: notifications.length, message: message, link:&#x27;drone&#x27;, id: assignment.assignedDrone.id, seen: false, time: self.getTime() });
			});
        });
		this.socketManager.register(&quot;assignmentCompleted&quot;, 0, &quot;dashboard&quot;, function(data, id) {
			self.adapter.find(&#x27;assignment&#x27;, id).then(function(assignment){
				var message = &#x27;Completed Assignment #&#x27; + id;
				var notifications = self.get(&#x27;notifications&#x27;);
				found = false;
				for(var i = 0; i &lt; self.notifications.length; ++i) {
					var n = self.notifications[i];
					if(n.link == &#x27;drone&#x27; &amp;&amp; n.id == assignment.assignedDrone.id) {
						Ember.set(self.notifications[i], &#x27;message&#x27;, message);
						Ember.set(self.notifications[i], &#x27;seen&#x27;, false);
						Ember.set(self.notifications[i], &#x27;id&#x27;, id);
						Ember.set(self.notifications[i], &#x27;link&#x27;, &#x27;assignment&#x27;);
						Ember.set(self.notifications[i], &#x27;time&#x27;, self.getTime());
						found = true;
						break;
					}
				}
				if(!found) 
					notifications.unshiftObject({ number: notifications.length, message: message, link:&#x27;assignment&#x27;, id: id, seen: false, time: self.getTime() });
			});
        });

        this.socketManager.register(&quot;locationChanged&quot;, 0, &quot;dashboard&quot;, function(data,id) {
            var locs = self.get(&quot;locations&quot;);
            if (!locs)
                return;

            var current = locs.filter(function(t) {return t.id === parseInt(id) &amp;&amp; t.type === &quot;drone&quot;;})[0];
            if (!current)
                return;
            current.set(&quot;lat&quot;, data.latitude);
            current.set(&quot;lon&quot;, data.longitude);
        });
    },

	getTime: function() {
		var dt = new Date();
		return &#x27;(&#x27; + dt.toLocaleTimeString() + &#x27;)&#x27;;
	},
	
	actions: {
		notificationClicked: function(item) {
			var notifications = this.get(&#x27;notifications&#x27;);
			for(var i = 0; i &lt; notifications.length; ++i) {
				var n = notifications[i];
				// All linked notifications
				if(n.link == item.link &amp;&amp; n.id == item.id)
					Ember.set(notifications[i], &#x27;seen&#x27;, true);
			}
			this.transitionToRoute(item.link, item.id);
		},
		
		removeSeenNotifications: function() {
			var removed = 0;
			var notifications = this.get(&#x27;notifications&#x27;);
			for(var i = notifications.length - 1; i &gt;=0; --i) {
				if(notifications[i].seen) {
					notifications.removeAt(i);
					removed++;
				} else
					Ember.set(notifications[i], &#x27;number&#x27;, notifications[i].number - removed);
			}
		}
	},
	
	notificationsAvailable: function() {
		return this.notifications.length &gt; 0;
	}.property(&#x27;notifications.@each&#x27;),
	
	isEnabled: function() {
		var enabled = false;
		var notifications = this.get(&#x27;notifications&#x27;);
		for(var i = 0; i &lt; notifications.length; ++i) {
			if(notifications[i].seen == true) {
				enabled = true;
				break;
			}
		}
		return enabled;
	}.property(&#x27;notifications.@each.seen&#x27;)
});
    </pre>
</div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
<script src="../assets/vendor/prettify/prettify-min.js"></script>
<script>prettyPrint();</script>
<script src="../assets/js/yui-prettify.js"></script>
<script src="../assets/../api.js"></script>
<script src="../assets/js/api-filter.js"></script>
<script src="../assets/js/api-list.js"></script>
<script src="../assets/js/api-search.js"></script>
<script src="../assets/js/apidocs.js"></script>
</body>
</html>
