<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>js\adapter.js - The cros-admin API</title>
    <link rel="stylesheet" href="http://yui.yahooapis.com/3.9.1/build/cssgrids/cssgrids-min.css">
    <link rel="stylesheet" href="../assets/vendor/prettify/prettify-min.css">
    <link rel="stylesheet" href="../assets/css/main.css" id="site_styles">
    <link rel="icon" href="../assets/favicon.ico">
    <script src="http://yui.yahooapis.com/combo?3.9.1/build/yui/yui-min.js"></script>
</head>
<body class="yui3-skin-sam">

<div id="doc">
    <div id="hd" class="yui3-g header">
        <div class="yui3-u-3-4">
                <h1><img src="../assets/css/logo.png" title="The cros-admin API" width="117" height="52"></h1>
        </div>
        <div class="yui3-u-1-4 version">
            <em>API Docs for: 1.0.0</em>
        </div>
    </div>
    <div id="bd" class="yui3-g">

        <div class="yui3-u-1-4">
            <div id="docs-sidebar" class="sidebar apidocs">
                <div id="api-list">
                    <h2 class="off-left">APIs</h2>
                    <div id="api-tabview" class="tabview">
                        <ul class="tabs">
                            <li><a href="#api-classes">Classes</a></li>
                            <li><a href="#api-modules">Modules</a></li>
                        </ul>
                
                        <div id="api-tabview-filter">
                            <input type="search" id="api-filter" placeholder="Type to filter APIs">
                        </div>
                
                        <div id="api-tabview-panel">
                            <ul id="api-classes" class="apis classes">
                                <li><a href="../classes/CustomAdapter.html">CustomAdapter</a></li>
                            </ul>
                
                            <ul id="api-modules" class="apis modules">
                                <li><a href="../modules/cros-admin.html">cros-admin</a></li>
                            </ul>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="yui3-u-3-4">
                <div id="api-options">
                    Show:
                    <label for="api-show-inherited">
                        <input type="checkbox" id="api-show-inherited" checked>
                        Inherited
                    </label>
            
                    <label for="api-show-protected">
                        <input type="checkbox" id="api-show-protected">
                        Protected
                    </label>
            
                    <label for="api-show-private">
                        <input type="checkbox" id="api-show-private">
                        Private
                    </label>
                    <label for="api-show-deprecated">
                        <input type="checkbox" id="api-show-deprecated">
                        Deprecated
                    </label>
            
                </div>
            
            <div class="apidocs">
                <div id="docs-main">
                    <div class="content">
<h1 class="file-heading">File: js\adapter.js</h1>

<div class="file">
    <pre class="code prettyprint linenums">
/**
 * @module cros-admin
 */

/**
 * This will create a new RestAdapter with support for HATEOAS.
 * @class CustomAdapter
 * @constructor
 * @extends DS.RESTAdapter
 */
App.CustomAdapter = DS.RESTAdapter.extend({
    /**
     * The root url to the used REST-API
     *
     * @public
     * @required
     * @property {string}  host
     */
    host : &quot;http://localhost:9000&quot;,
    /**
     *  The namespace of the REST-API (relative to the host url)
     *
     * @public
     * @default &quot;&quot;
     * @property {string} namespace
     */
    namespace : &quot;&quot;,
    /**
     * The key which will contain the HATEOAS links within json reponses
     *
     * @public
     * @default &quot;links&quot;
     * @property {string} linksKey
     */
	linksKey : &quot;links&quot;,
    /**
     * The delimiter used to build the keys in the linkLibrary
     *
     * @public
     * @default &quot;-&quot;
     * @property {string} delimiter
     */
	delimiter : &quot;-&quot;,
    /**
     * This object contains all links to REST calls. They are fetched from the REST responses and stored as a dictionary
     * that maps keys on urls.
     *
     * @private
     * @property linkLibrary
     * @type {object}
     */
    linkLibrary : {},

    /**
     * This method will perform the initialization of the adapter. It will insert one link in the {{#crossLink &quot;CustomAdapter/linkLibrary:property&quot;}}{{/crossLink}},
     * namely to the root (+namespace) of the REST-API.
     *
     * @public
     * @method init
     */
    init : function() {
        this._super();

        this.get(&quot;linkLibrary&quot;)[&quot;home&quot;] = this.get(&quot;host&quot;) + this.get(&quot;namespace&quot;);
    },

    /**
     * This property contains all the headers that should be sent with every request.
     * This now only contains the correct authentication token for the REST-API.
     *
     * @private
     * @property headers {object}
     */
    headers: function() {
        return {
            &quot;X-AUTH-TOKEN&quot; : this.authManager.token()
        };
    }.property().volatile(),

    /**
     * This function will process a received links object and enter the links in the {{#crossLink &quot;CustomAdapter/linkLibrary:property&quot;}}{{/crossLink}}.
     * This is done by iterating over the links available and inserting them with the correct key (based on the provided root).
     *
     * @private
     * @method insertLinks
     * @param linksObj the object containing all the links
     * @param root the root key that should be used for these links.
     */
	insertLinks : function(linksObj, root) {
		var self = this;
		$.each(linksObj, function(k, v) {
			if(k === &quot;self&quot;) {
				self.linkLibrary[root] = v
			} else {
                if (root !== &quot;&quot;) {
                    self.linkLibrary[root + self.delimiter + k] = v;
                } else {
                    self.linkLibrary[k] = v;
                }
			}
		});
	},

    /**
     * This function will search through the response json and search for objects with key {{#crossLink &quot;CustomAdapter/linksKey:property&quot;}}{{/crossLink}}.
     * For each object it finds, it will call {{#crossLink &quot;CustomAdapter/insertLinks:method&quot;}}{{/crossLink}} so that the contained links are added to the linkLibrary.
     *
     * In current version the home link is treated separately. Since the links in the root of this specific REST-API are not contained within a linkskey object,
     * they are just added to the linkLibrary directly.
     *
     * @private
     * @method processLinks
     * @param data The response json
     * @param root The root key of the links that should be added.
     */
	processLinks : function(data, root) {
        if (root === &quot;home&quot;) {
            $.extend(this.linkLibrary, data);
            return;
        }

		var lk = this.linksKey;
		var self = this;
        if (!data)
            return;

		$.each(data, function(k, v) {
			if (lk === k) {
				self.insertLinks(v, root);
			} else if(k === &quot;resource&quot;) { // lists of items are contained within a &quot;resource&quot; tag
				$.each(v, function(i, obj) {
					self.processLinks(obj, root + self.delimiter + obj.id);
				});
			}
		});
	},

    /**
     * Progress of an ajax call can be tracked with nProgress library.
     * Starting this tracking can be done with this function.
     *
     * @private
     * @method progressTracker
     * @returns {XMLHttpRequest}
     */
	progressTracker: function()
	{
		var xhr = new window.XMLHttpRequest();
	
		//Upload progress
		xhr.upload.addEventListener(&quot;progress&quot;, function(evt){
			if (evt.lengthComputable) {  
				NProgress.inc();
			}
		}, false); 
		
		//Download progress
		xhr.addEventListener(&quot;progress&quot;, function(evt){
			if (evt.lengthComputable) {  
				NProgress.inc();
			}
		}, false); 
		
		return xhr;
	},

    /**
     * When any request made by the adapter fails, this function is called. It will do necessary checks of the errorstatus and
     * the error response. If necessary, the adapter will call the logout functionality of the authManager.
     *
     * @private
     * @method onfailure
     * @param data the response from the ajax call
     * @returns {object} the response from the ajax call (for further chaining)
     */
    onfailure : function(data) {
        if (data.status === 401 &amp;&amp; this.authManager.get(&quot;isLoggedIn&quot;)) {
            this.socketManager.disconnect();
            this.authManager.logout();
            var url = window.location.href;
            var index = url.lastIndexOf(&quot;#&quot;);
            if (index === -1)
                window.location.href = url + &quot;#/login&quot;;
            else
                window.location.href = url.substr(0,url.lastIndexOf(&quot;#&quot;)+1) + &quot;/login&quot;;
        }
        return data;
    },

    /**
     * This method will fetch any missing links in the linklibrary. It will call ajax and use {{#crossLink &quot;CustomAdapter/processLinks:method&quot;}}{{/crossLink}}
     * to update the linksLibrary.
     *
     * @private
     * @method recursiveFetch
     * @param urlObj the url to be fetched
     * @param store the root key to use when inserting the links.
     * @returns {Promise} Any code executed after this promise will have the necessary links in the linkLibrary
     */
	recursiveFetch : function(urlObj, store) {
		var self = this;
		return self.ajax(urlObj.url, &#x27;GET&#x27;).then(function(data) {
			self.processLinks(data[store], urlObj.key);
		});
	},

    resolveLinkInner : function(store,id,action) {
        var key = store;
        var self = this;

        if (id)
            key += self.delimiter + id;
        if (action) {
            if (action instanceof Array)
                key += self.delimiter + action.join(self.delimiter);
            else
                key += self.delimiter + action;
        }

        var tempKey = key;
        var callsRemaining = true;
        var i = 0;
        var calls = [];
        while (!self.linkLibrary[tempKey]) {
            i = tempKey.lastIndexOf(self.delimiter);
            var temp;
            if (i == -1) {
                calls.push(&quot;home&quot;);
                callsRemaining = false;
                break;
            } else {
                temp = tempKey.substring(0,i);
                calls.push(temp);
            }
            tempKey = temp;
        }

        if(calls.length == 0) {
            return $.Deferred(function(defer) { defer.resolveWith(this,[{ &quot;url&quot; : self.linkLibrary[key], &quot;key&quot; : key }]); }).promise();
        } else {
            var currentPromise = this.get(&quot;currentRequest&quot;) || $.Deferred(function(defer) { defer.resolveWith(this,[]); });
            for (var i = 0; i &lt; calls.length; ++i) {
                currentPromise = currentPromise.then(function() { return self.recursiveFetch({ &quot;url&quot; : self.linkLibrary[calls[i]], &quot;key&quot; : calls[i] }, store); });
            }
            return currentPromise.then(function() {
                return { &quot;url&quot; : self.linkLibrary[key], &quot;key&quot; : key };
            });
        }
    },
	
	resolveLink : function(store, id, action) {
        var self = this;
        if (this.get(&quot;currentRequest&quot;)) {
            return this.get(&quot;currentRequest&quot;).then(function() {
                return self.resolveLinkInner(store,id,action);
            });
        } else {
            return this.resolveLinkInner(store,id,action);
        }
	},
	
	ajax : function(url, method, options) {
		hash = options || {};
		hash.url = url;
		hash.method = method;
		hash.dataType = &#x27;json&#x27;;
		hash.context = this;
		
		if (hash.data &amp;&amp; method !== &#x27;GET&#x27;) {
			hash.contentType = &#x27;application/json; charset=utf-8&#x27;;
			hash.data = JSON.stringify(hash.data);
		}
		
		var headers = this.get(&#x27;headers&#x27;);
		if (headers !== undefined) {
			hash.headers = headers;
		}
		
		return $.ajax(hash);
	},

    currentRequest: null,

    find : function(store, id, action, params) {
        var self = this;
        var r = this.get(&quot;currentRequest&quot;);

        var urlPromise;
        if (r) {
            urlPromise = r.then(function () {
                self.set(&quot;currentRequest&quot;, null);
                return this.resolveLink(store, id, action);
            });
        } else
            urlPromise = this.resolveLink(store,id,action);

        var urlObj;
        r = urlPromise.then(function(obj) {
            urlObj = obj;
            if (params) {
                if (params.query)
                    urlObj.url += &quot;?&quot; + $.param(params.query);
            }
            return self.ajax(urlObj.url, &#x27;GET&#x27;, params);
        }).then(function(data) {
            self.processLinks(data[store], urlObj.key);
            return data[store];
        }, self.onfailure);

        self.set(&quot;currentRequest&quot;, r);
        return r;
    },
    
    post : function(store, postData) {
		var self = this;
        var url = this.linkLibrary[store];
		return this.ajax(url, &#x27;POST&#x27;, {data: postData, xhr : self.progressTracker}).then(function(data) {
            self.processLinks(data, &quot;&quot;);
			return data;
		}, self.onfailure);
	},
    
	edit : function(store, id, editData) {
		var self = this;
		var url = this.linkLibrary[store + self.delimiter + id];
		return this.ajax(url, &#x27;PUT&#x27;, {data: editData, xhr : self.progressTracker}).then(function(data) {
			return data;
		}, self.onfailure);
	},
	
	remove : function(store, id) {
		var self = this;
		var url = this.linkLibrary[store + self.delimiter + id];
		return this.ajax(url, &#x27;DELETE&#x27;, { xhr : self.progressTracker}).then(function(data) {
			return data;
		}, self.onfailure);
	}
	
});
    </pre>
</div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
<script src="../assets/vendor/prettify/prettify-min.js"></script>
<script>prettyPrint();</script>
<script src="../assets/js/yui-prettify.js"></script>
<script src="../assets/../api.js"></script>
<script src="../assets/js/api-filter.js"></script>
<script src="../assets/js/api-list.js"></script>
<script src="../assets/js/api-search.js"></script>
<script src="../assets/js/apidocs.js"></script>
</body>
</html>
